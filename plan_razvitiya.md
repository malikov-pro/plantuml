# План разработки: Преобразование Redmine PlantUML плагина в аналог GitLab PlantUML интеграции

## Анализ текущего состояния

### Текущая архитектура Redmine PlantUML плагина:
- **Синтаксис**: `{{plantuml(png|svg) диаграмма }}`
- **Обработка**: Создание `.pu` файлов, вызов локального PlantUML binary
- **Кэширование**: SHA256 хэш на основе содержимого диаграммы
- **Форматы**: PNG, SVG
- **Безопасность**: Санитизация `!include` директив
- **UI**: Кнопка в toolbar для вставки макроса

### GitLab PlantUML интеграция (цель):
- **Синтаксис**: оставить прежним `{{plantuml(png|svg)}}`
- **Обработка**: Формирование URL ссылок на PlantUML сервер
- **Кэширование**: На уровне NGINX сервера (прокси кэш)
- **Генерация**: PlantUML сервер генерирует изображения "на лету"
- **Безопасность**: Изоляция PlantUML сервера

## Фазы разработки

### Фаза 1: Подготовка инфраструктуры (1 день)

#### 1.1 Обновление конфигурации плагина
**Промпт для разработки:**
```
Обнови конфигурацию Redmine PlantUML плагина для работы через PlantUML сервер:
1. Добавь настройку plantuml_server_url в settings (по умолчанию http://localhost:8005)
2. Удали настройку plantuml_binary_path
3. Обнови app/views/settings/_plantuml.html.erb - убери поле binary path
4. Добавь валидацию URL сервера (проверка доступности)
5. Обнови совместимость с Redmine 5.x и 6.x в init.rb
```

#### 1.3 Обновление совместимости с Redmine 5.x и 6.x
**Промпт для разработки:**
```
Обнови совместимость плагина с новыми версиями Redmine:
1. Измени requires_redmine в init.rb с '2.6'..'4.1' на '5.0'..'6.1'
2. Протестируй совместимость с Redmine 5.0.13, 5.1.9, 6.0.6
3. Обнови использование deprecated методов если они есть
4. Проверь совместимость с новой структурой assets в Redmine 6
5. Обнови тесты для работы с новыми версиями Rails
```

#### 1.2 Изменение логики генерации ссылок
**Промпт для разработки:**
```
Измени PlantumlHelper для генерации URL вместо локальных файлов:
1. Замени метод plantuml на generate_plantuml_url
2. Реализуй кодирование PlantUML кода в URL (deflate/base64)
3. Верни URL вида: {server_url}/{format}/{encoded_diagram}
4. Убери создание локальных .pu и .png/.svg файлов
5. Сохрани sanitize_plantuml для безопасности
```

### Фаза 2: Настройка NGINX кэширования (0.5 дня)

#### 2.1 Конфигурация NGINX прокси
**Промпт для разработки:**
```
Настрой NGINX для проксирования и кэширования PlantUML запросов:
1. Добавь location /-/plantuml/ для проксирования на PlantUML сервер
2. Настрой proxy_cache с TTL 24 часа для изображений
3. Добавь заголовки кэширования (Cache-Control, ETag)
4. Настрой gzip сжатие для SVG
```

### Фаза 3: Обновление контроллера (0.5 дня)

#### 3.1 Упрощение PlantUML контроллера
**Промпт для разработки:**
```
Упрости PlantumlController для работы через прокси:
1. Убери метод convert (файлы больше не отдаются локально)
2. Добавь метод proxy для редиректа на PlantUML сервер (опционально)
3. Обнови routes.rb - убери старые роуты или сделай редиректы
4. Добавь health check метод для проверки доступности сервера
```

### Фаза 4: Улучшение UI/UX (1 день)

#### 4.1 Обновление редактора
**Промпт для разработки:**
```
Обнови интерфейс редактора для работы с новой системой:
1. Сохрани кнопку PlantUML в toolbar (без изменений)
2. Добавь индикатор статуса PlantUML сервера в админке
3. Добавь превью диаграмм в реальном времени при редактировании
4. Покажи URL диаграммы для отладки (в dev режиме)
```

#### 4.2 Улучшение отображения
**Промпт для разработки:**
```
Улучши отображение PlantUML диаграмм:
1. Добавь fallback изображение при недоступности сервера
2. Реализуй lazy loading для больших диаграмм
3. Добавь возможность открытия диаграммы в новой вкладке
4. Покажи источник диаграммы при клике (опционально)
```

### Фаза 5: Тестирование и очистка (1 день)

#### 5.1 Обновление тестов
**Промпт для разработки:**
```
Обнови тесты для новой архитектуры и совместимости:
1. Измени unit тесты PlantumlHelper для URL генерации
2. Добавь mock PlantUML сервера для тестов
3. Протестируй работу при недоступности сервера
4. Проверь корректность URL кодирования
5. Протестируй совместимость с Redmine 5.0.13, 5.1.9, 6.0.6
6. Проверь работу с Rails 6 (Redmine 5.x) и Rails 7 (Redmine 6.x)
```

#### 5.2 Очистка старого кода
**Промпт для разработки:**
```
Удали неиспользуемый код:
1. Убери методы создания локальных файлов из PlantumlHelper
2. Удали cleanup.rake таск (файлы больше не создаются)
3. Убери обработку content_type в контроллере
4. Обнови тесты - убери проверки локальных файлов
```

### Фаза 6: Документация и миграция (0.5 дня)

#### 6.1 Обновление документации
**Промпт для разработки:**
```
Обнови документацию плагина:
1. Добавь инструкции по настройке PlantUML Docker сервера
2. Документируй настройку NGINX прокси и кэширования
3. Опиши преимущества новой архитектуры
4. Добавь troubleshooting для проблем с сервером
```

## Технические требования

### Обновления зависимостей:
- **base64**: Для кодирования PlantUML диаграмм в URL
- **zlib**: Для deflate сжатия (стандарт PlantUML)
- **uri**: Для работы с URL и валидации

### Удаляемые файлы:
```
lib/tasks/cleanup.rake       # Больше не нужен - файлы не создаются
test/fixtures/files/*        # Тестовые файлы больше не используются
```

### Изменяемые файлы:
```
app/helpers/plantuml_helper.rb      # Основная логика URL генерации
app/controllers/plantuml_controller.rb  # Упрощение или удаление
app/views/settings/_plantuml.html.erb   # Убрать binary path
config/routes.rb                     # Обновить или удалить роуты
init.rb                             # Новые настройки + совместимость с Redmine 5-6
lib/plantuml_helper_patch.rb        # Обновление для совместимости с Rails 7
```

### Настройки конфигурации:
```ruby
# init.rb
Redmine::Plugin.register :plantuml do
  name 'PlantUML plugin for Redmine'
  author 'Michael Skrynski'
  description 'This is a plugin for Redmine which renders PlantUML diagrams.'
  version '1.0.0'
  url 'https://github.com/dkd/plantuml'

  requires_redmine version: '5.0'..'6.1'  # Поддержка Redmine 5.x и 6.x

  settings(
    partial: 'settings/plantuml',
    default: {
      'plantuml_server_url' => 'http://localhost:8005',
      'allow_includes' => false,
      'encoding' => 'deflate'              # deflate|base64
    }
  )
  
  # Остальная конфигурация макросов...
end
```

### NGINX конфигурация:
```nginx
location /-/plantuml/ {
    proxy_pass http://localhost:8005/;
    proxy_cache plantuml_cache;
    proxy_cache_valid 200 24h;
    proxy_cache_key "$request_uri";
    add_header X-Cache-Status $upstream_cache_status;
}
```

## Риски и митигации

### Риск 1: Совместимость с существующими диаграммами
**Митигация**: Сохранение полной обратной совместимости с `{{plantuml()}}` макросами

### Риск 2: Совместимость с Redmine 5.x и 6.x
**Митигация**: Использование `requires_redmine` согласно [Plugin FAQ](https://www.redmine.org/projects/redmine/wiki/Plugin_FAQ) и тестирование на актуальных версиях

### Риск 3: Производительность HTTP запросов
**Митигация**: Агрессивное кэширование и асинхронная обработка

### Риск 4: Недоступность PlantUML сервера
**Митигация**: Показ placeholder изображения и graceful degradation

### Риск 5: Безопасность PlantUML кода
**Митигация**: Строгая валидация и изоляция PlantUML сервера

### Риск 6: Изменения в Rails 7 (Redmine 6.x)
**Митигация**: Обновление deprecated методов и тестирование на Rails 7

## Критерии успеха

1. **Функциональность**: URL-based генерация диаграмм как в GitLab
2. **Производительность**: Время рендеринга диаграмм < 2 секунд
3. **Совместимость диаграмм**: 100% работоспособность существующих диаграмм
4. **Совместимость Redmine**: Поддержка Redmine 5.0+ и 6.0+ согласно [Plugin FAQ](https://www.redmine.org/projects/redmine/wiki/Plugin_FAQ)
5. **Безопасность**: Отсутствие уязвимостей через PlantUML код
6. **UX**: Улучшенный интерфейс редактирования и превью

## Временная оценка: 3-4 дня

- **Критический путь**: Фазы 1-3 (базовая функциональность)
- **Улучшения**: Фаза 4 (UI/UX)
- **Обязательное**: Фазы 5-6 (тестирование и документация)

## Заключение

Данный план позволит поэтапно преобразовать Redmine PlantUML плагин в современное решение, аналогичное GitLab интеграции, с сохранением обратной совместимости и добавлением новых возможностей. 